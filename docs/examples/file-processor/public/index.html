<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>File Processor Example</title>
  <style>
    * {
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }
    body {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    h1 { color: #333; }
    .upload-area {
      border: 2px dashed #ccc;
      padding: 40px;
      text-align: center;
      background: white;
      border-radius: 8px;
      margin-bottom: 20px;
      transition: border-color 0.3s;
    }
    .upload-area.dragover {
      border-color: #007bff;
      background: #f0f7ff;
    }
    .upload-area input[type="file"] {
      display: none;
    }
    .upload-area label {
      cursor: pointer;
      color: #007bff;
      font-weight: 500;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    button:hover { background: #0056b3; }
    button:disabled { background: #ccc; }
    .files-section {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-top: 20px;
    }
    .files-section h2 {
      margin-top: 0;
      font-size: 18px;
    }
    .file-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 15px;
    }
    .file-card {
      border: 1px solid #ddd;
      border-radius: 8px;
      overflow: hidden;
      background: #fafafa;
    }
    .file-card img {
      width: 100%;
      height: 120px;
      object-fit: cover;
    }
    .file-card .info {
      padding: 10px;
      font-size: 12px;
    }
    .file-card .filename {
      font-weight: 500;
      word-break: break-all;
    }
    .status {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
      margin-top: 5px;
    }
    .status.pending { background: #fff3cd; color: #856404; }
    .status.processing { background: #cce5ff; color: #004085; }
    .status.processed { background: #d4edda; color: #155724; }
    .status.failed { background: #f8d7da; color: #721c24; }
    #log {
      background: #222;
      color: #0f0;
      padding: 15px;
      border-radius: 8px;
      font-family: monospace;
      font-size: 12px;
      height: 200px;
      overflow-y: auto;
      margin-top: 20px;
    }
    .stats {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
    }
    .stat {
      background: white;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
    }
    .stat .number {
      font-size: 24px;
      font-weight: bold;
      color: #007bff;
    }
    .stat .label {
      font-size: 12px;
      color: #666;
    }
  </style>
</head>
<body>
  <h1>File Processor Example</h1>

  <div class="upload-area" id="dropzone">
    <p>Drag and drop files here, or <label for="fileInput">browse</label></p>
    <input type="file" id="fileInput" multiple accept="image/*,.pdf,video/*">
    <p style="font-size: 12px; color: #666;">Supports: Images (jpg, png, gif, webp), PDFs, Videos (mp4, mov, webm)</p>
  </div>

  <div class="stats">
    <div class="stat">
      <div class="number" id="pendingCount">0</div>
      <div class="label">Pending</div>
    </div>
    <div class="stat">
      <div class="number" id="processedCount">0</div>
      <div class="label">Processed</div>
    </div>
    <div class="stat">
      <div class="number" id="failedCount">0</div>
      <div class="label">Failed</div>
    </div>
  </div>

  <div class="files-section">
    <h2>Processed Files</h2>
    <div class="file-grid" id="processedFiles"></div>
  </div>

  <div id="log"></div>

  <script>
    const dropzone = document.getElementById('dropzone');
    const fileInput = document.getElementById('fileInput');
    const log = document.getElementById('log');

    // Drag and drop handlers
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      dropzone.addEventListener(eventName, e => {
        e.preventDefault();
        e.stopPropagation();
      });
    });

    ['dragenter', 'dragover'].forEach(eventName => {
      dropzone.addEventListener(eventName, () => dropzone.classList.add('dragover'));
    });

    ['dragleave', 'drop'].forEach(eventName => {
      dropzone.addEventListener(eventName, () => dropzone.classList.remove('dragover'));
    });

    dropzone.addEventListener('drop', e => {
      handleFiles(e.dataTransfer.files);
    });

    fileInput.addEventListener('change', e => {
      handleFiles(e.target.files);
    });

    function logMessage(msg) {
      const time = new Date().toLocaleTimeString();
      log.innerHTML += `[${time}] ${msg}\n`;
      log.scrollTop = log.scrollHeight;
    }

    async function handleFiles(files) {
      for (const file of files) {
        await uploadFile(file);
      }
    }

    async function uploadFile(file) {
      const formData = new FormData();
      formData.append('file', file);

      logMessage(`Uploading: ${file.name}`);

      try {
        const res = await fetch('/upload', {
          method: 'POST',
          body: formData
        });
        const data = await res.json();
        logMessage(`Uploaded: ${data.filename} - Waiting for processing...`);
        pollStatus(data.filename);
      } catch (err) {
        logMessage(`Error uploading ${file.name}: ${err.message}`);
      }
    }

    async function pollStatus(filename) {
      const maxAttempts = 60; // 60 seconds
      let attempts = 0;

      const poll = async () => {
        try {
          const res = await fetch(`/status/${filename}`);
          const data = await res.json();

          if (data.status === 'processed') {
            logMessage(`Processed: ${filename}`);
            refreshFiles();
            return;
          }

          if (data.status === 'failed') {
            logMessage(`Failed: ${filename} - ${data.error}`);
            refreshFiles();
            return;
          }

          if (attempts < maxAttempts) {
            attempts++;
            setTimeout(poll, 1000);
          } else {
            logMessage(`Timeout waiting for: ${filename}`);
          }
        } catch (err) {
          logMessage(`Error checking status: ${err.message}`);
        }
      };

      poll();
    }

    async function refreshFiles() {
      try {
        const res = await fetch('/files');
        const data = await res.json();

        document.getElementById('pendingCount').textContent = data.pending;
        document.getElementById('processedCount').textContent = data.processed;
        document.getElementById('failedCount').textContent = data.failed;

        const grid = document.getElementById('processedFiles');
        grid.innerHTML = '';

        // Show processed files (filter out thumbnails and info files)
        const mainFiles = data.files.processed.filter(f =>
          !f.includes('.thumb.') &&
          !f.includes('.info.') &&
          !f.includes('.preview.') &&
          !f.endsWith('.txt')
        );

        mainFiles.forEach(filename => {
          const ext = filename.split('.').pop().toLowerCase();
          const basename = filename.substring(0, filename.lastIndexOf('.'));
          const isImage = ['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(ext);

          const card = document.createElement('div');
          card.className = 'file-card';

          if (isImage) {
            card.innerHTML = `
              <img src="/processed/${basename}.thumb.jpg" onerror="this.src='/processed/${filename}'">
              <div class="info">
                <div class="filename">${filename}</div>
                <span class="status processed">Processed</span>
              </div>
            `;
          } else {
            card.innerHTML = `
              <div style="height:120px;background:#eee;display:flex;align-items:center;justify-content:center;">
                ${ext.toUpperCase()}
              </div>
              <div class="info">
                <div class="filename">${filename}</div>
                <span class="status processed">Processed</span>
              </div>
            `;
          }

          grid.appendChild(card);
        });

      } catch (err) {
        logMessage(`Error refreshing files: ${err.message}`);
      }
    }

    // Refresh files periodically
    setInterval(refreshFiles, 5000);
    refreshFiles();

    logMessage('File processor example ready');
  </script>
</body>
</html>
