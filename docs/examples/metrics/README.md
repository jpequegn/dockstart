# Metrics Example Project

This example demonstrates how to set up Prometheus metrics in a Node.js application and use dockstart to generate the metrics stack.

## Quick Start

```bash
# Generate devcontainer files
cd docs/examples/metrics
dockstart .

# Start the devcontainer (in VS Code, or manually)
docker compose -f .devcontainer/docker-compose.yml up -d

# Install dependencies and start the app
npm install
npm start
```

## Access Points

| Service | URL | Description |
|---------|-----|-------------|
| Application | http://localhost:3000 | Your Express app |
| Metrics | http://localhost:3000/metrics | Prometheus metrics endpoint |
| Prometheus | http://localhost:9090 | Query metrics |
| Grafana | http://localhost:3001 | Dashboards (admin/admin) |

## Available Metrics

### Default Metrics (via `collectDefaultMetrics()`)

| Metric | Type | Description |
|--------|------|-------------|
| `app_process_cpu_seconds_total` | Counter | CPU time used |
| `app_process_resident_memory_bytes` | Gauge | Memory usage |
| `app_nodejs_eventloop_lag_seconds` | Gauge | Event loop lag |
| `app_nodejs_active_handles_total` | Gauge | Active handles |
| `app_nodejs_gc_duration_seconds` | Histogram | GC duration |

### HTTP Metrics

| Metric | Type | Labels | Description |
|--------|------|--------|-------------|
| `http_requests_total` | Counter | method, path, status | Total HTTP requests |
| `http_request_duration_seconds` | Histogram | method, path | Request duration |
| `active_connections` | Gauge | - | Active connections |

### Business Metrics

| Metric | Type | Labels | Description |
|--------|------|--------|-------------|
| `orders_total` | Counter | status | Orders created |
| `order_processing_seconds` | Histogram | - | Order processing time |
| `pending_orders` | Gauge | - | Pending orders |

## Example Queries

Open Prometheus at http://localhost:9090/graph and try these queries:

### Request Rate
```promql
rate(http_requests_total[5m])
```

### Average Response Time
```promql
rate(http_request_duration_seconds_sum[5m]) / rate(http_request_duration_seconds_count[5m])
```

### 95th Percentile Latency
```promql
histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))
```

### Error Rate
```promql
100 * sum(rate(http_requests_total{status=~"5.."}[5m])) / sum(rate(http_requests_total[5m]))
```

### Order Success Rate
```promql
100 * sum(rate(orders_total{status="success"}[5m])) / sum(rate(orders_total[5m]))
```

## Generate Traffic

Use these curl commands to generate test traffic:

```bash
# Basic requests
curl http://localhost:3000/api/users
curl http://localhost:3000/api/users/123

# Create orders (some will fail)
for i in {1..20}; do
  curl -X POST http://localhost:3000/api/orders \
    -H "Content-Type: application/json" \
    -d '{"item": "widget"}'
done

# Generate errors
curl http://localhost:3000/api/error

# Slow endpoint
curl http://localhost:3000/api/reports
```

## Project Structure

```
metrics/
├── package.json         # Dependencies (express, prom-client)
├── src/
│   └── index.js        # Application with metrics
├── README.md           # This file
└── .devcontainer/      # Generated by dockstart
    ├── devcontainer.json
    ├── docker-compose.yml
    ├── Dockerfile
    ├── prometheus/
    │   └── prometheus.yml
    └── grafana/
        └── provisioning/
            ├── datasources/
            │   └── prometheus.yml
            └── dashboards/
                ├── provider.yml
                └── app-metrics.json
```

## Key Concepts Demonstrated

### 1. Default Metrics
The example uses `collectDefaultMetrics()` to automatically track Node.js runtime metrics like memory, CPU, and event loop lag.

### 2. Counter Metrics
`http_requests_total` and `orders_total` demonstrate counters - metrics that only increase.

### 3. Histogram Metrics
`http_request_duration_seconds` demonstrates histograms for tracking distributions with percentiles.

### 4. Gauge Metrics
`active_connections` and `pending_orders` demonstrate gauges - metrics that can go up and down.

### 5. Labels
Metrics use labels (method, path, status) to add dimensions without creating new metric names.

### 6. Path Normalization
The `normalizePath()` function prevents high cardinality by replacing dynamic path segments with placeholders.

## Next Steps

1. **Add custom dashboards**: Import the pre-built dashboard and add new panels
2. **Add alerts**: Configure Alertmanager for production use
3. **Add more metrics**: Track business KPIs, cache hit rates, etc.
4. **Add distributed tracing**: Integrate with Jaeger or Zipkin

## See Also

- [Metrics Stack Documentation](../../sidecars/metrics.md)
- [PromQL Cheatsheet](../../sidecars/promql-cheatsheet.md)
- [prom-client Documentation](https://github.com/siimon/prom-client)
