# Worker Sidecar Example

This example demonstrates dockstart's background worker sidecar generation using a Node.js application with BullMQ.

## Project Structure

```
worker/
â”œâ”€â”€ package.json          # Dependencies including bullmq
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ index.js         # Main Express API
â”‚   â”œâ”€â”€ worker.js        # BullMQ worker
â”‚   â””â”€â”€ jobs/
â”‚       â””â”€â”€ email.js     # Job processor
â””â”€â”€ .devcontainer/       # Generated by dockstart
    â”œâ”€â”€ devcontainer.json
    â”œâ”€â”€ docker-compose.yml
    â””â”€â”€ Dockerfile
```

## How It Works

1. **Detection**: dockstart detects `bullmq` in package.json
2. **Worker Command**: Finds `"worker": "node src/worker.js"` in scripts
3. **Redis**: Auto-adds Redis since BullMQ requires it
4. **Generation**: Creates docker-compose.yml with app + worker + redis

## Try It

```bash
# From dockstart root
cd docs/examples/worker

# Run dockstart
../../dockstart .

# Output:
# ğŸ“‚ Analyzing .
# ğŸ” Detecting project configuration...
#    âœ… Detected: node 20 (confidence: 100%)
#    ğŸ“¦ Services: [redis]
#    ğŸ‘· Worker: bullmq (command: npm run worker)
#
# ğŸ“ Generating devcontainer.json...
# ğŸ“ Generating docker-compose.yml...
# ğŸ“ Generating Dockerfile...
```

## Generated Files

### docker-compose.yml

```yaml
services:
  app:
    build:
      context: ..
      dockerfile: .devcontainer/Dockerfile
    volumes:
      - ..:/workspace:cached
    depends_on:
      - redis
    environment:
      - REDIS_URL=redis://redis:6379

  worker:
    build:
      context: ..
      dockerfile: .devcontainer/Dockerfile
    volumes:
      - ..:/workspace:cached
    command: npm run worker
    depends_on:
      - app
      - redis
    environment:
      - REDIS_URL=redis://redis:6379
      - WORKER_CONCURRENCY=2
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    volumes:
      - redis-data:/data

volumes:
  redis-data:
```

## Running the Example

```bash
# Start all services
docker compose up -d

# View logs
docker compose logs -f

# Scale workers
docker compose up -d --scale worker=3

# Test job creation (from app container)
docker compose exec app curl -X POST http://localhost:3000/jobs/email \
  -H "Content-Type: application/json" \
  -d '{"to": "user@example.com", "subject": "Hello"}'

# Check worker processing
docker compose logs -f worker
```

## Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   API Server   â”‚â”€â”€â”€â”€â–¶â”‚    BullMQ      â”‚â”€â”€â”€â”€â–¶â”‚     Redis      â”‚
â”‚  (Express.js)  â”‚     â”‚   (Queue)      â”‚     â”‚  (Job Store)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ Jobs
                              â–¼
                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                       â”‚    Worker      â”‚
                       â”‚ (npm run       â”‚
                       â”‚    worker)     â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Key Points

1. **Same Image**: Worker uses same Dockerfile as app
2. **Different Command**: Only the command differs (`npm run worker`)
3. **Shared Volume**: Both containers see the same `/workspace`
4. **Auto-Redis**: Redis added automatically for BullMQ
5. **Restart Policy**: Worker has `restart: unless-stopped`
