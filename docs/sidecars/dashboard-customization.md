# Grafana Dashboard Customization Guide

This guide explains how to customize the pre-built Grafana dashboards generated by dockstart.

## Accessing Grafana

1. Open http://localhost:3001 in your browser
2. Login with `admin` / `admin` (default credentials)
3. Navigate to Dashboards > Browse
4. Select the auto-generated dashboard

## Dashboard Overview

The pre-built dashboard includes four panels:

| Panel | Visualization | Purpose |
|-------|---------------|---------|
| Request Rate | Time series | HTTP requests per second |
| Response Time Percentiles | Time series | p50, p95, p99 latency |
| Error Rate (5xx) | Time series | Percentage of 5xx errors |
| Requests by Status Code | Time series | Status code breakdown |

## Adding New Panels

### Step 1: Enter Edit Mode

1. Click the dashboard title
2. Click "Edit" or press `E`

### Step 2: Add Panel

1. Click "Add" button in the top toolbar
2. Select "Visualization"
3. Choose your panel type (Time series, Gauge, Stat, etc.)

### Step 3: Configure Query

1. Select "Prometheus" as the datasource
2. Enter your PromQL query
3. Configure legend format using `{{label_name}}` syntax

### Step 4: Customize Appearance

- **Panel options**: Title, description, transparent background
- **Field options**: Unit, thresholds, color scheme
- **Standard options**: Min/max, decimals, display name

### Step 5: Save

1. Click "Apply" to save the panel
2. Click the save icon (disk) to save the dashboard
3. Optionally add a description for the change

## Common Panel Types

### Stat Panel (Single Value)
Best for: Current values, totals, gauges

```promql
# Current active connections
active_connections

# Total requests in last hour
increase(http_requests_total[1h])
```

### Time Series Panel
Best for: Trends over time, multiple series

```promql
# Request rate by endpoint
rate(http_requests_total[5m])

# Response time comparison
histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))
```

### Gauge Panel
Best for: Percentage values, thresholds

```promql
# Error rate percentage
100 * sum(rate(http_requests_total{status=~"5.."}[5m])) / sum(rate(http_requests_total[5m]))
```

### Bar Gauge Panel
Best for: Comparing values across labels

```promql
# Requests by endpoint
sum by (path) (rate(http_requests_total[5m]))
```

### Table Panel
Best for: Detailed breakdown, multiple columns

```promql
# Endpoint statistics
sum by (path, method) (rate(http_requests_total[5m]))
```

### Heatmap Panel
Best for: Distribution over time

```promql
# Request duration distribution
sum by (le) (rate(http_request_duration_seconds_bucket[5m]))
```

## Creating Custom Dashboards

### From Scratch

1. Click "+" in the sidebar
2. Select "Dashboard"
3. Click "Add visualization"
4. Build your panels

### From Template

1. Click "+" > "Import"
2. Enter a Grafana dashboard ID (from grafana.com/dashboards)
3. Select the Prometheus datasource
4. Customize as needed

### Recommended Community Dashboards

| ID | Name | Use Case |
|----|------|----------|
| 1860 | Node Exporter Full | System metrics |
| 9628 | PostgreSQL Database | Postgres metrics |
| 763 | Redis Dashboard | Redis metrics |
| 6239 | Docker Container | Container metrics |

## Variables and Templating

### Adding a Variable

1. Click Dashboard settings (gear icon)
2. Select "Variables"
3. Click "New variable"

### Common Variable Types

**Query Variable** - Populate from Prometheus labels:
```promql
label_values(http_requests_total, path)
```

**Custom Variable** - Static list of options:
```
value1, value2, value3
```

**Interval Variable** - Time intervals:
```
1m, 5m, 15m, 30m, 1h, 6h, 12h, 24h
```

### Using Variables in Queries

```promql
# Filter by selected path
rate(http_requests_total{path="$path"}[$__interval])

# Use with regex
rate(http_requests_total{path=~"$path"}[5m])
```

## Annotations

Annotations mark events on graphs (deploys, incidents, etc.).

### Adding an Annotation

1. Dashboard settings > Annotations
2. Click "New annotation query"
3. Configure the query:

```promql
# Example: Mark when error rate spikes
sum(rate(http_requests_total{status=~"5.."}[1m])) / sum(rate(http_requests_total[1m])) > 0.1
```

## Alerts (Grafana Alerting)

### Creating an Alert

1. Edit a panel
2. Click the "Alert" tab
3. Click "Create alert rule from this panel"
4. Configure conditions:

```yaml
# Example: Alert when error rate > 5%
Condition:
  WHEN avg() OF query(A, 5m, now) IS ABOVE 0.05
```

### Alert Destinations

Configure in Alerting > Contact points:
- Email
- Slack
- PagerDuty
- Webhooks

## Exporting Dashboards

### Export as JSON

1. Dashboard settings (gear icon)
2. Click "JSON Model"
3. Copy the JSON

### Save to Provisioning

1. Export the JSON
2. Save to `.devcontainer/grafana/provisioning/dashboards/`
3. Name it descriptively: `my-custom-dashboard.json`
4. The dashboard will auto-load on container restart

### Export to File

```bash
# Using Grafana API
curl -H "Authorization: Bearer <api-key>" \
  http://localhost:3001/api/dashboards/uid/<dashboard-uid> \
  | jq '.dashboard' > custom-dashboard.json
```

## Best Practices

### Panel Design

1. **Clear titles**: Use descriptive names, not just metric names
2. **Appropriate units**: Configure units (req/s, bytes, seconds)
3. **Meaningful thresholds**: Add color thresholds for status
4. **Consistent time ranges**: Use dashboard time range, not per-panel

### Query Optimization

1. **Use recording rules** for complex, frequently-used queries
2. **Limit cardinality** in label selectors
3. **Use `rate()` for counters**, not raw values
4. **Set appropriate resolution** (don't over-sample)

### Dashboard Organization

1. **Group related panels** using rows
2. **Use consistent color schemes** across dashboards
3. **Add documentation** in panel descriptions
4. **Version control** your dashboard JSON

## Troubleshooting

### Panel Shows "No Data"

1. Check time range - expand if recent
2. Verify metric exists in Prometheus
3. Check label filters match actual values
4. Ensure datasource is correctly configured

### Slow Dashboard Loading

1. Reduce time range
2. Add more specific filters
3. Use recording rules for complex queries
4. Increase query timeout in datasource settings

### Variable Dropdown Empty

1. Check the variable query syntax
2. Verify labels exist in Prometheus
3. Ensure regex is valid if using pattern

## See Also

- [Metrics Stack Documentation](./metrics.md)
- [PromQL Cheatsheet](./promql-cheatsheet.md)
- [Grafana Documentation](https://grafana.com/docs/grafana/latest/)
- [Grafana Dashboards Gallery](https://grafana.com/grafana/dashboards/)
