# Backup Sidecar Container
# Generated by dockstart - https://github.com/jpequegn/dockstart
#
# This container runs scheduled database backups using Supercronic.
# Backups are stored in /backup which should be mounted as a volume.

FROM alpine:3.19

LABEL maintainer="dockstart"
LABEL description="Database backup sidecar for development environments"

# Install common utilities
RUN apk add --no-cache \
    bash \
    gzip \
    docker-cli \
    curl \
    ca-certificates

# Install database-specific backup tools
{{- if .HasPostgres}}
# PostgreSQL client for pg_dump
RUN apk add --no-cache postgresql16-client
{{- end}}

{{- if .HasMySQL}}
# MySQL client for mysqldump
RUN apk add --no-cache mysql-client
{{- end}}

{{- if .HasRedis}}
# Redis client for redis-cli
RUN apk add --no-cache redis
{{- end}}

{{- if .HasSQLite}}
# SQLite for .backup command
RUN apk add --no-cache sqlite
{{- end}}

# Install Supercronic for container-native cron scheduling
# Supercronic is designed for containers: preserves env vars, logs to stdout
ARG SUPERCRONIC_VERSION=v0.2.29
ARG SUPERCRONIC_SHA256=cd48d45c4b10f3f0bfdd3a57d054cd05ac96812b408c2b4e1a4d98f88e0d0e8b
RUN curl -fsSL "https://github.com/aptible/supercronic/releases/download/${SUPERCRONIC_VERSION}/supercronic-linux-amd64" \
    -o /usr/local/bin/supercronic \
    && echo "${SUPERCRONIC_SHA256}  /usr/local/bin/supercronic" | sha256sum -c - \
    && chmod +x /usr/local/bin/supercronic

# Create backup directory
RUN mkdir -p /backup /var/log

# Copy backup scripts
COPY scripts/backup.sh /usr/local/bin/backup.sh
{{- if .HasPostgres}}
COPY scripts/backup-postgres.sh /usr/local/bin/backup-postgres.sh
COPY scripts/restore-postgres.sh /usr/local/bin/restore-postgres.sh
{{- end}}
{{- if .HasMySQL}}
COPY scripts/backup-mysql.sh /usr/local/bin/backup-mysql.sh
COPY scripts/restore-mysql.sh /usr/local/bin/restore-mysql.sh
{{- end}}
{{- if .HasRedis}}
COPY scripts/backup-redis.sh /usr/local/bin/backup-redis.sh
COPY scripts/restore-redis.sh /usr/local/bin/restore-redis.sh
{{- end}}
{{- if .HasSQLite}}
COPY scripts/backup-sqlite.sh /usr/local/bin/backup-sqlite.sh
COPY scripts/restore-sqlite.sh /usr/local/bin/restore-sqlite.sh
{{- end}}
RUN chmod +x /usr/local/bin/*.sh

# Copy crontab
COPY crontab /etc/crontab

# Create entrypoint script
COPY entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# Backup volume
VOLUME ["/backup"]

# Health check - verify supercronic is running
HEALTHCHECK --interval=60s --timeout=10s --start-period=10s --retries=3 \
    CMD pgrep -f supercronic || exit 1

ENTRYPOINT ["/entrypoint.sh"]
CMD ["supercronic", "/etc/crontab"]
