# File Processor Sidecar Container
# Generated by dockstart - https://github.com/jpequegn/dockstart
#
# This container watches for new files and processes them automatically.
# Files should be placed in /files/pending and will be processed to /files/processed.

FROM alpine:3.19

LABEL maintainer="dockstart"
LABEL description="File processor sidecar for development environments"

# Install common utilities
RUN apk add --no-cache \
    bash \
    coreutils \
    findutils \
    file

# Install file watching tools
{{- if .UseInotify}}
# inotify-tools for efficient file watching (Linux only)
RUN apk add --no-cache inotify-tools
{{- end}}

# Install image processing tools
{{- if .ProcessImages}}
# ImageMagick for image resizing, conversion, and optimization
RUN apk add --no-cache \
    imagemagick \
    jpegoptim \
    pngquant
{{- end}}

# Install document processing tools
{{- if .ProcessDocuments}}
# Poppler for PDF text extraction and manipulation
RUN apk add --no-cache \
    poppler-utils
{{- end}}

# Install video processing tools
{{- if .ProcessVideo}}
# FFmpeg for video transcoding and thumbnail generation
RUN apk add --no-cache \
    ffmpeg
{{- end}}

# Create directory structure for file processing pipeline
# pending/     - App uploads files here
# processing/  - Files being actively processed
# processed/   - Successfully processed files
# failed/      - Files that failed processing
RUN mkdir -p \
    /files/pending \
    /files/processing \
    /files/processed \
    /files/failed

# Copy processing scripts
COPY scripts/process-files.sh /usr/local/bin/process-files.sh
{{- if .ProcessImages}}
COPY scripts/process-image.sh /usr/local/bin/process-image.sh
{{- end}}
{{- if .ProcessDocuments}}
COPY scripts/process-document.sh /usr/local/bin/process-document.sh
{{- end}}
{{- if .ProcessVideo}}
COPY scripts/process-video.sh /usr/local/bin/process-video.sh
{{- end}}
RUN chmod +x /usr/local/bin/*.sh

# Create entrypoint script
COPY entrypoint.processor.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# Files volume - shared with app container
VOLUME ["/files"]

# Health check - verify processing script is running
HEALTHCHECK --interval=30s --timeout=10s --start-period=10s --retries=3 \
    CMD pgrep -f process-files.sh || exit 1

ENTRYPOINT ["/entrypoint.sh"]
CMD ["/usr/local/bin/process-files.sh"]
