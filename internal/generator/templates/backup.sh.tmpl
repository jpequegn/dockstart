#!/bin/bash
# Main Backup Script
# Generated by dockstart - https://github.com/jpequegn/dockstart
#
# This script runs all configured database backups.
# Individual database scripts can be run directly for manual backups.

set -eo pipefail

echo "=============================================="
echo "[$(date)] Starting backup run"
echo "=============================================="

BACKUP_DIR="${BACKUP_DIR:-/backup}"
mkdir -p "${BACKUP_DIR}"

# Track success/failure
TOTAL=0
SUCCESS=0
FAILED=0

{{- if .HasPostgres}}

# PostgreSQL backup
echo ""
echo "[$(date)] Running PostgreSQL backup..."
TOTAL=$((TOTAL + 1))
if /usr/local/bin/backup-postgres.sh; then
    SUCCESS=$((SUCCESS + 1))
    echo "[$(date)] PostgreSQL backup: SUCCESS"
else
    FAILED=$((FAILED + 1))
    echo "[$(date)] PostgreSQL backup: FAILED"
fi
{{- end}}

{{- if .HasMySQL}}

# MySQL backup
echo ""
echo "[$(date)] Running MySQL backup..."
TOTAL=$((TOTAL + 1))
if /usr/local/bin/backup-mysql.sh; then
    SUCCESS=$((SUCCESS + 1))
    echo "[$(date)] MySQL backup: SUCCESS"
else
    FAILED=$((FAILED + 1))
    echo "[$(date)] MySQL backup: FAILED"
fi
{{- end}}

{{- if .HasRedis}}

# Redis backup
echo ""
echo "[$(date)] Running Redis backup..."
TOTAL=$((TOTAL + 1))
if /usr/local/bin/backup-redis.sh; then
    SUCCESS=$((SUCCESS + 1))
    echo "[$(date)] Redis backup: SUCCESS"
else
    FAILED=$((FAILED + 1))
    echo "[$(date)] Redis backup: FAILED"
fi
{{- end}}

{{- if .HasSQLite}}

# SQLite backup
echo ""
echo "[$(date)] Running SQLite backup..."
TOTAL=$((TOTAL + 1))
if /usr/local/bin/backup-sqlite.sh; then
    SUCCESS=$((SUCCESS + 1))
    echo "[$(date)] SQLite backup: SUCCESS"
else
    FAILED=$((FAILED + 1))
    echo "[$(date)] SQLite backup: FAILED"
fi
{{- end}}

echo ""
echo "=============================================="
echo "[$(date)] Backup run complete"
echo "[$(date)] Results: ${SUCCESS}/${TOTAL} successful, ${FAILED} failed"
echo "=============================================="

# List current backups
echo ""
echo "Current backups in ${BACKUP_DIR}:"
ls -lh "${BACKUP_DIR}"/*.gz 2>/dev/null || echo "  No backups found"

# Exit with error if any backup failed
if [ "${FAILED}" -gt 0 ]; then
    exit 1
fi
