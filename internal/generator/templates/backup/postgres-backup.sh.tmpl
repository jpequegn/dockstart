#!/bin/sh
# PostgreSQL Backup Script
# Generated by dockstart - https://github.com/jpequegn/dockstart
#
# This script creates compressed PostgreSQL backups and manages rotation.
# Schedule with cron: 0 3 * * * /usr/local/bin/backup.sh

set -e

# Configuration from environment
DB_HOST="${DB_HOST:-{{.DatabaseHost}}}"
DB_USER="${DB_USER:-{{.DatabaseUser}}}"
DB_NAME="${DB_NAME:-{{.DatabaseName}}}"
DB_PASSWORD="${DB_PASSWORD:-{{.DatabasePassword}}}"
BACKUP_DIR="${BACKUP_DIR:-/backup}"
RETENTION_DAYS="${RETENTION_DAYS:-{{.RetentionDays}}}"
COMPRESSION_LEVEL="${COMPRESSION_LEVEL:-6}"

# Generate timestamp
TIMESTAMP=$(date +%Y-%m-%dT%H-%M-%S)
BACKUP_FILE="${BACKUP_DIR}/{{.ContainerName}}-${TIMESTAMP}.sql.gz"

# Ensure backup directory exists
mkdir -p "${BACKUP_DIR}"

echo "[$(date)] Starting PostgreSQL backup..."
echo "[$(date)] Host: ${DB_HOST}, Database: ${DB_NAME}"

# Create backup with pg_dump
# --no-owner: Don't output ownership commands (portable across users)
# --clean: Add DROP statements before CREATE
# --if-exists: Use IF EXISTS with DROP statements
export PGPASSWORD="${DB_PASSWORD}"
pg_dump \
  -h "${DB_HOST}" \
  -U "${DB_USER}" \
  -d "${DB_NAME}" \
  --no-owner \
  --clean \
  --if-exists \
  | gzip -${COMPRESSION_LEVEL} > "${BACKUP_FILE}"

# Verify backup was created
if [ ! -f "${BACKUP_FILE}" ]; then
  echo "[$(date)] ERROR: Backup file was not created!"
  exit 1
fi

BACKUP_SIZE=$(du -h "${BACKUP_FILE}" | cut -f1)
echo "[$(date)] Backup completed: ${BACKUP_FILE}"
echo "[$(date)] Backup size: ${BACKUP_SIZE}"

# Rotate old backups
echo "[$(date)] Rotating backups older than ${RETENTION_DAYS} days..."
DELETED=$(find "${BACKUP_DIR}" -name "{{.ContainerName}}-*.sql.gz" -mtime +${RETENTION_DAYS} -delete -print | wc -l)
echo "[$(date)] Deleted ${DELETED} old backup(s)"

# List remaining backups
REMAINING=$(find "${BACKUP_DIR}" -name "{{.ContainerName}}-*.sql.gz" | wc -l)
echo "[$(date)] Total backups: ${REMAINING}"

echo "[$(date)] PostgreSQL backup complete"
