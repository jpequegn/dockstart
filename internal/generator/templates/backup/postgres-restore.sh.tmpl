#!/bin/sh
# PostgreSQL Restore Script
# Generated by dockstart - https://github.com/jpequegn/dockstart
#
# Usage: ./restore.sh /backup/postgres-2025-12-20T03-00-00.sql.gz

set -e

# Configuration from environment
DB_HOST="${DB_HOST:-{{.DatabaseHost}}}"
DB_USER="${DB_USER:-{{.DatabaseUser}}}"
DB_NAME="${DB_NAME:-{{.DatabaseName}}}"
DB_PASSWORD="${DB_PASSWORD:-{{.DatabasePassword}}}"

# Check arguments
if [ -z "$1" ]; then
  echo "Usage: $0 <backup-file.sql.gz>"
  echo ""
  echo "Available backups:"
  ls -lh /backup/{{.ContainerName}}-*.sql.gz 2>/dev/null || echo "  No backups found"
  exit 1
fi

BACKUP_FILE="$1"

# Verify backup file exists
if [ ! -f "${BACKUP_FILE}" ]; then
  echo "[$(date)] ERROR: Backup file not found: ${BACKUP_FILE}"
  exit 1
fi

echo "[$(date)] Starting PostgreSQL restore..."
echo "[$(date)] Backup file: ${BACKUP_FILE}"
echo "[$(date)] Target: ${DB_HOST}/${DB_NAME}"
echo ""
echo "WARNING: This will overwrite all data in ${DB_NAME}!"
echo "Press Ctrl+C within 5 seconds to cancel..."
sleep 5

# Restore from backup
export PGPASSWORD="${DB_PASSWORD}"
gunzip -c "${BACKUP_FILE}" | psql \
  -h "${DB_HOST}" \
  -U "${DB_USER}" \
  -d "${DB_NAME}" \
  --quiet

echo "[$(date)] Restore completed successfully"
echo "[$(date)] Database ${DB_NAME} has been restored from ${BACKUP_FILE}"
