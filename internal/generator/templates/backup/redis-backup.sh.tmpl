#!/bin/sh
# Redis Backup Script
# Generated by dockstart - https://github.com/jpequegn/dockstart
#
# This script creates Redis RDB backups and manages rotation.
# Schedule with cron: 0 */6 * * * /usr/local/bin/backup.sh

set -e

# Configuration from environment
REDIS_HOST="${REDIS_HOST:-{{.DatabaseHost}}}"
REDIS_PORT="${REDIS_PORT:-6379}"
REDIS_PASSWORD="${REDIS_PASSWORD:-}"
BACKUP_DIR="${BACKUP_DIR:-/backup}"
RETENTION_DAYS="${RETENTION_DAYS:-{{.RetentionDays}}}"
COMPRESSION_LEVEL="${COMPRESSION_LEVEL:-6}"

# Generate timestamp
TIMESTAMP=$(date +%Y-%m-%dT%H-%M-%S)
BACKUP_FILE="${BACKUP_DIR}/{{.ContainerName}}-${TIMESTAMP}.rdb.gz"

# Ensure backup directory exists
mkdir -p "${BACKUP_DIR}"

echo "[$(date)] Starting Redis backup..."
echo "[$(date)] Host: ${REDIS_HOST}:${REDIS_PORT}"

# Build redis-cli command with optional password
REDIS_CLI="redis-cli -h ${REDIS_HOST} -p ${REDIS_PORT}"
if [ -n "${REDIS_PASSWORD}" ]; then
  REDIS_CLI="${REDIS_CLI} -a ${REDIS_PASSWORD}"
fi

# Get last save time before triggering new save
LAST_SAVE_BEFORE=$(${REDIS_CLI} LASTSAVE 2>/dev/null || echo "0")

# Trigger background save
echo "[$(date)] Triggering BGSAVE..."
${REDIS_CLI} BGSAVE >/dev/null 2>&1

# Wait for save to complete (poll until LASTSAVE changes)
echo "[$(date)] Waiting for save to complete..."
WAIT_COUNT=0
MAX_WAIT=60
while [ "${WAIT_COUNT}" -lt "${MAX_WAIT}" ]; do
  sleep 1
  LAST_SAVE_AFTER=$(${REDIS_CLI} LASTSAVE 2>/dev/null || echo "0")
  if [ "${LAST_SAVE_AFTER}" != "${LAST_SAVE_BEFORE}" ]; then
    echo "[$(date)] Save completed"
    break
  fi
  WAIT_COUNT=$((WAIT_COUNT + 1))
done

if [ "${WAIT_COUNT}" -ge "${MAX_WAIT}" ]; then
  echo "[$(date)] WARNING: Timeout waiting for BGSAVE, proceeding anyway"
fi

# Copy and compress the RDB file
# Using docker cp to get the file from the Redis container
echo "[$(date)] Copying and compressing RDB file..."
docker cp "{{.ContainerName}}:/data/dump.rdb" - 2>/dev/null | gzip -${COMPRESSION_LEVEL} > "${BACKUP_FILE}"

# Verify backup was created
if [ ! -f "${BACKUP_FILE}" ] || [ ! -s "${BACKUP_FILE}" ]; then
  echo "[$(date)] ERROR: Backup file was not created or is empty!"
  exit 1
fi

BACKUP_SIZE=$(du -h "${BACKUP_FILE}" | cut -f1)
echo "[$(date)] Backup completed: ${BACKUP_FILE}"
echo "[$(date)] Backup size: ${BACKUP_SIZE}"

# Rotate old backups
echo "[$(date)] Rotating backups older than ${RETENTION_DAYS} days..."
DELETED=$(find "${BACKUP_DIR}" -name "{{.ContainerName}}-*.rdb.gz" -mtime +${RETENTION_DAYS} -delete -print | wc -l)
echo "[$(date)] Deleted ${DELETED} old backup(s)"

# List remaining backups
REMAINING=$(find "${BACKUP_DIR}" -name "{{.ContainerName}}-*.rdb.gz" | wc -l)
echo "[$(date)] Total backups: ${REMAINING}"

echo "[$(date)] Redis backup complete"
