#!/bin/sh
# Redis Restore Script
# Generated by dockstart - https://github.com/jpequegn/dockstart
#
# Usage: ./restore.sh /backup/redis-2025-12-20T03-00-00.rdb.gz

set -e

# Configuration from environment
REDIS_CONTAINER="${REDIS_CONTAINER:-{{.ContainerName}}}"

# Check arguments
if [ -z "$1" ]; then
  echo "Usage: $0 <backup-file.rdb.gz>"
  echo ""
  echo "Available backups:"
  ls -lh /backup/{{.ContainerName}}-*.rdb.gz 2>/dev/null || echo "  No backups found"
  exit 1
fi

BACKUP_FILE="$1"

# Verify backup file exists
if [ ! -f "${BACKUP_FILE}" ]; then
  echo "[$(date)] ERROR: Backup file not found: ${BACKUP_FILE}"
  exit 1
fi

echo "[$(date)] Starting Redis restore..."
echo "[$(date)] Backup file: ${BACKUP_FILE}"
echo "[$(date)] Target container: ${REDIS_CONTAINER}"
echo ""
echo "WARNING: This will stop Redis and overwrite all data!"
echo "Press Ctrl+C within 5 seconds to cancel..."
sleep 5

# Stop Redis container
echo "[$(date)] Stopping Redis container..."
docker stop "${REDIS_CONTAINER}"

# Extract and copy the RDB file
echo "[$(date)] Restoring RDB file..."
gunzip -c "${BACKUP_FILE}" > /tmp/dump.rdb
docker cp /tmp/dump.rdb "${REDIS_CONTAINER}:/data/dump.rdb"
rm /tmp/dump.rdb

# Start Redis container
echo "[$(date)] Starting Redis container..."
docker start "${REDIS_CONTAINER}"

# Wait for Redis to be ready
echo "[$(date)] Waiting for Redis to be ready..."
sleep 3

echo "[$(date)] Restore completed successfully"
echo "[$(date)] Redis has been restored from ${BACKUP_FILE}"
