#!/bin/sh
# SQLite Backup Script
# Generated by dockstart - https://github.com/jpequegn/dockstart
#
# This script creates SQLite backups using VACUUM INTO and manages rotation.
# Note: Stops the app container to ensure consistent backup.
# Schedule with cron: 0 3 * * * /usr/local/bin/backup.sh

set -e

# Configuration from environment
DB_PATH="${DB_PATH:-{{.DatabasePath}}}"
APP_CONTAINER="${APP_CONTAINER:-{{.AppContainer}}}"
BACKUP_DIR="${BACKUP_DIR:-/backup}"
RETENTION_DAYS="${RETENTION_DAYS:-{{.RetentionDays}}}"
COMPRESSION_LEVEL="${COMPRESSION_LEVEL:-6}"
STOP_CONTAINER="${STOP_CONTAINER:-true}"

# Generate timestamp
TIMESTAMP=$(date +%Y-%m-%dT%H-%M-%S)
BACKUP_FILE="${BACKUP_DIR}/{{.ContainerName}}-${TIMESTAMP}.db.gz"
TEMP_BACKUP="/tmp/sqlite_backup_${TIMESTAMP}.db"

# Ensure backup directory exists
mkdir -p "${BACKUP_DIR}"

echo "[$(date)] Starting SQLite backup..."
echo "[$(date)] Database: ${DB_PATH}"

# Stop app container for consistent backup
if [ "${STOP_CONTAINER}" = "true" ]; then
  echo "[$(date)] Stopping ${APP_CONTAINER} for consistent backup..."
  docker stop "${APP_CONTAINER}" >/dev/null 2>&1 || true
fi

# Create optimized backup using VACUUM INTO
# This creates a minimal, defragmented copy
echo "[$(date)] Creating backup with VACUUM INTO..."
sqlite3 "${DB_PATH}" "VACUUM INTO '${TEMP_BACKUP}'"

# Compress the backup
gzip -${COMPRESSION_LEVEL} -c "${TEMP_BACKUP}" > "${BACKUP_FILE}"
rm -f "${TEMP_BACKUP}"

# Restart app container
if [ "${STOP_CONTAINER}" = "true" ]; then
  echo "[$(date)] Restarting ${APP_CONTAINER}..."
  docker start "${APP_CONTAINER}" >/dev/null 2>&1
fi

# Verify backup was created
if [ ! -f "${BACKUP_FILE}" ]; then
  echo "[$(date)] ERROR: Backup file was not created!"
  exit 1
fi

BACKUP_SIZE=$(du -h "${BACKUP_FILE}" | cut -f1)
echo "[$(date)] Backup completed: ${BACKUP_FILE}"
echo "[$(date)] Backup size: ${BACKUP_SIZE}"

# Rotate old backups
echo "[$(date)] Rotating backups older than ${RETENTION_DAYS} days..."
DELETED=$(find "${BACKUP_DIR}" -name "{{.ContainerName}}-*.db.gz" -mtime +${RETENTION_DAYS} -delete -print | wc -l)
echo "[$(date)] Deleted ${DELETED} old backup(s)"

# List remaining backups
REMAINING=$(find "${BACKUP_DIR}" -name "{{.ContainerName}}-*.db.gz" | wc -l)
echo "[$(date)] Total backups: ${REMAINING}"

echo "[$(date)] SQLite backup complete"
