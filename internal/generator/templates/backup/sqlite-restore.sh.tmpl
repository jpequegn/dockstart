#!/bin/sh
# SQLite Restore Script
# Generated by dockstart - https://github.com/jpequegn/dockstart
#
# Usage: ./restore.sh /backup/sqlite-2025-12-20T03-00-00.db.gz

set -e

# Configuration from environment
DB_PATH="${DB_PATH:-{{.DatabasePath}}}"
APP_CONTAINER="${APP_CONTAINER:-{{.AppContainer}}}"

# Check arguments
if [ -z "$1" ]; then
  echo "Usage: $0 <backup-file.db.gz>"
  echo ""
  echo "Available backups:"
  ls -lh /backup/{{.ContainerName}}-*.db.gz 2>/dev/null || echo "  No backups found"
  exit 1
fi

BACKUP_FILE="$1"

# Verify backup file exists
if [ ! -f "${BACKUP_FILE}" ]; then
  echo "[$(date)] ERROR: Backup file not found: ${BACKUP_FILE}"
  exit 1
fi

echo "[$(date)] Starting SQLite restore..."
echo "[$(date)] Backup file: ${BACKUP_FILE}"
echo "[$(date)] Target: ${DB_PATH}"
echo ""
echo "WARNING: This will stop the app and overwrite the database!"
echo "Press Ctrl+C within 5 seconds to cancel..."
sleep 5

# Stop app container
echo "[$(date)] Stopping ${APP_CONTAINER}..."
docker stop "${APP_CONTAINER}" 2>/dev/null || true

# Backup current database (just in case)
if [ -f "${DB_PATH}" ]; then
  TIMESTAMP=$(date +%Y-%m-%dT%H-%M-%S)
  echo "[$(date)] Creating backup of current database..."
  cp "${DB_PATH}" "${DB_PATH}.pre-restore.${TIMESTAMP}"
fi

# Restore from backup
echo "[$(date)] Restoring database..."
gunzip -c "${BACKUP_FILE}" > "${DB_PATH}"

# Start app container
echo "[$(date)] Starting ${APP_CONTAINER}..."
docker start "${APP_CONTAINER}"

echo "[$(date)] Restore completed successfully"
echo "[$(date)] SQLite database has been restored from ${BACKUP_FILE}"
