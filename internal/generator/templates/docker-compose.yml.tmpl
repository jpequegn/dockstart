# Docker Compose configuration for {{.Name}} development environment
# Generated by dockstart - https://github.com/jpequegn/dockstart

services:
  # Main application container
  app:
    build:
      context: ..
      dockerfile: .devcontainer/Dockerfile
    volumes:
      - ..:/workspace:cached
    command: sleep infinity
{{- if .Services}}
    depends_on:
{{- range .Services}}
      - {{.Name}}
{{- end}}
    environment:
{{- range .Services}}
{{- if eq .Name "postgres"}}
      - DATABASE_URL=postgres://postgres:postgres@postgres:5432/{{$.Name}}_dev
{{- end}}
{{- if eq .Name "redis"}}
      - REDIS_URL=redis://redis:6379
{{- end}}
{{- end}}
{{- end}}
{{range .Services}}

  # {{.Name}} service
  {{.Name}}:
{{- if eq .Name "postgres"}}
    image: postgres:16-alpine
    restart: unless-stopped
    volumes:
      - postgres-data:/var/lib/postgresql/data
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: {{$.Name}}_dev
    ports:
      - "5432:5432"
{{- end}}
{{- if eq .Name "redis"}}
    image: redis:7-alpine
    restart: unless-stopped
    volumes:
      - redis-data:/data
    ports:
      - "6379:6379"
{{- end}}
{{- end}}
{{- if .Services}}

volumes:
{{- range .Services}}
{{- if eq .Name "postgres"}}
  postgres-data:
{{- end}}
{{- if eq .Name "redis"}}
  redis-data:
{{- end}}
{{- end}}
{{- end}}
