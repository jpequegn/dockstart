# Docker Compose configuration for {{.Name}} development environment
# Generated by dockstart - https://github.com/jpequegn/dockstart

services:
  # Main application container
  app:
    build:
      context: ..
      dockerfile: .devcontainer/Dockerfile
    volumes:
      - ..:/workspace:cached
{{- if .FileProcessorSidecar.Enabled}}
      - uploads:/uploads
{{- end}}
    command: sleep infinity
{{- if or .Services .LogSidecar.Enabled}}
    depends_on:
{{- range .Services}}
      - {{.Name}}
{{- end}}
{{- if .LogSidecar.Enabled}}
      - fluent-bit
{{- end}}
{{- end}}
{{- if or .Services .LogSidecar.Enabled .FileProcessorSidecar.Enabled}}
    environment:
{{- range .Services}}
{{- if eq .Name "postgres"}}
      - DATABASE_URL=postgres://postgres:postgres@postgres:5432/{{$.Name}}_dev
{{- end}}
{{- if eq .Name "redis"}}
      - REDIS_URL=redis://redis:6379
{{- end}}
{{- end}}
{{- if .LogSidecar.Enabled}}
      - LOG_LEVEL=debug
{{- end}}
{{- if .FileProcessorSidecar.Enabled}}
      - UPLOAD_PATH=/uploads/pending
      - PROCESSED_PATH=/uploads/processed
      - FAILED_PATH=/uploads/failed
{{- end}}
{{- end}}
{{- if .LogSidecar.Enabled}}
    logging:
      driver: fluentd
      options:
        fluentd-address: localhost:24224
        tag: app.{{.Name}}
        fluentd-async: "true"
{{- end}}
{{- if .WorkerSidecar.Enabled}}

  # Background worker process
  # Uses same Dockerfile as app but with different command
  worker:
    build:
      context: ..
      dockerfile: .devcontainer/Dockerfile
    volumes:
      - ..:/workspace:cached
{{- if $.FileProcessorSidecar.Enabled}}
      - uploads:/uploads
{{- end}}
    command: {{.WorkerSidecar.Command}}
    depends_on:
      - app
{{- range .Services}}
      - {{.Name}}
{{- end}}
    environment:
      - WORKER_CONCURRENCY=2
      - NODE_ENV=development
{{- range .Services}}
{{- if eq .Name "postgres"}}
      - DATABASE_URL=postgres://postgres:postgres@postgres:5432/{{$.Name}}_dev
{{- end}}
{{- if eq .Name "redis"}}
      - REDIS_URL=redis://redis:6379
{{- end}}
{{- end}}
{{- if $.FileProcessorSidecar.Enabled}}
      - UPLOAD_PATH=/uploads/pending
      - PROCESSED_PATH=/uploads/processed
      - FAILED_PATH=/uploads/failed
{{- end}}
    restart: unless-stopped
{{- if $.LogSidecar.Enabled}}
    logging:
      driver: fluentd
      options:
        fluentd-address: localhost:24224
        tag: worker.{{$.Name}}
        fluentd-async: "true"
{{- end}}
{{- end}}
{{range .Services}}

  # {{.Name}} service
  {{.Name}}:
{{- if eq .Name "postgres"}}
    image: postgres:16-alpine
    restart: unless-stopped
    volumes:
      - postgres-data:/var/lib/postgresql/data
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: {{$.Name}}_dev
    ports:
      - "5432:5432"
{{- end}}
{{- if eq .Name "redis"}}
    image: redis:7-alpine
    restart: unless-stopped
    volumes:
      - redis-data:/data
    ports:
      - "6379:6379"
{{- end}}
{{- end}}
{{- if .LogSidecar.Enabled}}

  # Log aggregator sidecar (Fluent Bit)
  # Collects logs from app container via Docker logging driver
  fluent-bit:
    image: fluent/fluent-bit:latest
    restart: unless-stopped
    volumes:
      - ./fluent-bit.conf:/fluent-bit/etc/fluent-bit.conf:ro
    ports:
      - "24224:24224"
      - "24224:24224/udp"
{{- end}}
{{- if .FileProcessorSidecar.Enabled}}

  # File processor sidecar
  # Processes uploaded files (resize images, extract text, generate thumbnails)
  file-processor:
    build:
      context: .
      dockerfile: Dockerfile.processor
    volumes:
      - uploads:/uploads
    depends_on:
      - app
    environment:
      - PENDING_PATH=/uploads/pending
      - PROCESSING_PATH=/uploads/processing
      - PROCESSED_PATH=/uploads/processed
      - FAILED_PATH=/uploads/failed
      - POLL_INTERVAL=5
      - MAX_FILE_SIZE=52428800
      - RETRY_COUNT=3
      - NOTIFY_METHOD=file
    deploy:
      resources:
        limits:
          memory: {{.FileProcessorSidecar.MemoryLimit}}
          cpus: '{{.FileProcessorSidecar.CPULimit}}'
    restart: unless-stopped
{{- end}}
{{- if or .Services .LogSidecar.Enabled .BackupSidecar.Enabled .FileProcessorSidecar.Enabled}}

volumes:
{{- range .Services}}
{{- if eq .Name "postgres"}}
  postgres-data:
{{- end}}
{{- if eq .Name "redis"}}
  redis-data:
{{- end}}
{{- end}}
{{- if .LogSidecar.Enabled}}
  fluent-bit-logs:
{{- end}}
{{- if .BackupSidecar.Enabled}}
  backups:
{{- end}}
{{- if .FileProcessorSidecar.Enabled}}
  uploads:
{{- end}}
{{- end}}
{{- if .BackupSidecar.Enabled}}

  # Database backup sidecar
  # Runs scheduled backups using Supercronic
  db-backup:
    build:
      context: .
      dockerfile: Dockerfile.backup
    volumes:
      - ./backups:/backup
{{- if .BackupSidecar.NeedsDockerSocket}}
      - /var/run/docker.sock:/var/run/docker.sock:ro
{{- end}}
    depends_on:
{{- range .Services}}
      - {{.Name}}
{{- end}}
    environment:
      - BACKUP_DIR=/backup
      - RETENTION_DAYS={{.BackupSidecar.RetentionDays}}
{{- if .BackupSidecar.HasPostgres}}
      - DB_HOST=postgres
      - DB_USER=postgres
      - DB_PASSWORD=postgres
      - DB_NAME={{$.Name}}_dev
{{- end}}
{{- if .BackupSidecar.HasMySQL}}
      - DB_HOST=mysql
      - DB_USER=root
      - DB_PASSWORD=mysql
      - DB_NAME={{$.Name}}_dev
{{- end}}
{{- if .BackupSidecar.HasRedis}}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
{{- end}}
    restart: unless-stopped
{{- end}}
