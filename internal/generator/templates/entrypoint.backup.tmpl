#!/bin/bash
# Backup Container Entrypoint
# Generated by dockstart - https://github.com/jpequegn/dockstart
#
# This script initializes the backup container and runs supercronic.

set -eo pipefail

echo "=============================================="
echo "Backup Sidecar Container Starting"
echo "=============================================="
echo ""

# Show configuration
echo "Configuration:"
echo "  BACKUP_DIR: ${BACKUP_DIR:-/backup}"
echo "  RETENTION_DAYS: ${RETENTION_DAYS:-7}"
{{- if .HasPostgres}}
echo "  PostgreSQL: ${DB_HOST:-postgres}:${DB_PORT:-5432}/${DB_NAME:-database}"
{{- end}}
{{- if .HasMySQL}}
echo "  MySQL: ${DB_HOST:-mysql}:${DB_PORT:-3306}/${DB_NAME:-database}"
{{- end}}
{{- if .HasRedis}}
echo "  Redis: ${REDIS_HOST:-redis}:${REDIS_PORT:-6379}"
{{- end}}
{{- if .HasSQLite}}
echo "  SQLite: ${DB_PATH:-/data/database.db}"
{{- end}}
echo ""

# Wait for databases to be ready
echo "Waiting for databases to be ready..."
{{- if .HasPostgres}}
echo "  Checking PostgreSQL..."
until pg_isready -h "${DB_HOST:-postgres}" -p "${DB_PORT:-5432}" -U "${DB_USER:-postgres}" >/dev/null 2>&1; do
    echo "    PostgreSQL not ready, waiting..."
    sleep 2
done
echo "    PostgreSQL is ready"
{{- end}}

{{- if .HasMySQL}}
echo "  Checking MySQL..."
until mysqladmin ping -h "${DB_HOST:-mysql}" -P "${DB_PORT:-3306}" -u "${DB_USER:-root}" -p"${DB_PASSWORD:-}" --silent >/dev/null 2>&1; do
    echo "    MySQL not ready, waiting..."
    sleep 2
done
echo "    MySQL is ready"
{{- end}}

{{- if .HasRedis}}
echo "  Checking Redis..."
until redis-cli -h "${REDIS_HOST:-redis}" -p "${REDIS_PORT:-6379}" ping >/dev/null 2>&1; do
    echo "    Redis not ready, waiting..."
    sleep 2
done
echo "    Redis is ready"
{{- end}}

echo ""
echo "All databases are ready"
echo ""

# Create backup directory if it doesn't exist
mkdir -p "${BACKUP_DIR:-/backup}"

# Run initial backup if requested
if [ "${RUN_INITIAL_BACKUP:-false}" = "true" ]; then
    echo "Running initial backup..."
    /usr/local/bin/backup.sh || echo "Initial backup had errors (continuing anyway)"
    echo ""
fi

# Show schedule
echo "Backup schedule (from /etc/crontab):"
cat /etc/crontab
echo ""

echo "Starting supercronic scheduler..."
echo "=============================================="
echo ""

# Execute the command (default: supercronic /etc/crontab)
exec "$@"
