#!/bin/bash
# File Processor Container Entrypoint
# Generated by dockstart - https://github.com/jpequegn/dockstart
#
# This script initializes the file processor container.

set -eo pipefail

echo "=============================================="
echo "File Processor Sidecar Starting"
echo "=============================================="
echo ""

# Show configuration
echo "Configuration:"
echo "  PENDING_PATH: ${PENDING_PATH:-/files/pending}"
echo "  PROCESSING_PATH: ${PROCESSING_PATH:-/files/processing}"
echo "  PROCESSED_PATH: ${PROCESSED_PATH:-/files/processed}"
echo "  FAILED_PATH: ${FAILED_PATH:-/files/failed}"
echo "  POLL_INTERVAL: ${POLL_INTERVAL:-5}s"
echo "  MAX_FILE_SIZE: ${MAX_FILE_SIZE:-52428800} bytes ($(( ${MAX_FILE_SIZE:-52428800} / 1024 / 1024 ))MB)"
echo "  RETRY_COUNT: ${RETRY_COUNT:-3}"
echo "  NOTIFY_METHOD: ${NOTIFY_METHOD:-file}"
echo ""

echo "Processing capabilities:"
{{- if .ProcessImages}}
echo "  - Images: resize, thumbnail, optimize (ImageMagick)"
{{- end}}
{{- if .ProcessDocuments}}
echo "  - Documents: PDF text extraction (Poppler)"
{{- end}}
{{- if .ProcessVideo}}
echo "  - Video: thumbnails, previews, metadata (FFmpeg)"
{{- end}}
echo ""

# Ensure directories exist
echo "Creating directory structure..."
mkdir -p "${PENDING_PATH:-/files/pending}"
mkdir -p "${PROCESSING_PATH:-/files/processing}"
mkdir -p "${PROCESSED_PATH:-/files/processed}"
mkdir -p "${FAILED_PATH:-/files/failed}"
echo "  Directories ready"
echo ""

# Check for leftover files in processing directory (from previous crash)
LEFTOVER=$(find "${PROCESSING_PATH:-/files/processing}" -type f 2>/dev/null | wc -l | tr -d ' ')
if [ "$LEFTOVER" -gt 0 ]; then
    echo "WARNING: Found $LEFTOVER file(s) in processing directory from previous run"
    echo "  Moving to pending for reprocessing..."
    find "${PROCESSING_PATH:-/files/processing}" -type f -exec mv {} "${PENDING_PATH:-/files/pending}/" \; 2>/dev/null || true
    echo ""
fi

# Show pending files
PENDING=$(find "${PENDING_PATH:-/files/pending}" -type f 2>/dev/null | wc -l | tr -d ' ')
if [ "$PENDING" -gt 0 ]; then
    echo "Found $PENDING pending file(s) to process"
    echo ""
fi

echo "Starting file processor..."
echo "=============================================="
echo ""

# Execute the command (default: /usr/local/bin/process-files.sh)
exec "$@"
