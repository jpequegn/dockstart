#!/bin/bash
# Document Processor Script
# Generated by dockstart - https://github.com/jpequegn/dockstart
#
# Processes document files: extract text from PDFs

set -eo pipefail

# Configuration
PROCESSED_DIR="${PROCESSED_PATH:-/files/processed}"

# Input file
INPUT="$1"
FILENAME=$(basename "$INPUT")
BASENAME="${FILENAME%.*}"
EXTENSION="${FILENAME##*.}"
EXTENSION_LOWER=$(echo "$EXTENSION" | tr '[:upper:]' '[:lower:]')

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] [document] $*"
}

log "Processing document: $FILENAME"

case "$EXTENSION_LOWER" in
    pdf)
        # Copy original PDF
        cp "$INPUT" "$PROCESSED_DIR/$FILENAME"

        # Extract text content using pdftotext
        if command -v pdftotext >/dev/null 2>&1; then
            pdftotext -layout "$INPUT" "$PROCESSED_DIR/${BASENAME}.txt" 2>/dev/null || true
            log "Extracted text to: ${BASENAME}.txt"
        fi

        # Get PDF info
        if command -v pdfinfo >/dev/null 2>&1; then
            pdfinfo "$INPUT" > "$PROCESSED_DIR/${BASENAME}.info" 2>/dev/null || true
            log "Created info file: ${BASENAME}.info"
        fi

        # Create thumbnail of first page
        if command -v pdftoppm >/dev/null 2>&1; then
            pdftoppm -jpeg -f 1 -l 1 -scale-to 400 "$INPUT" "$PROCESSED_DIR/${BASENAME}" 2>/dev/null || true
            # pdftoppm adds -1 suffix
            if [ -f "$PROCESSED_DIR/${BASENAME}-1.jpg" ]; then
                mv "$PROCESSED_DIR/${BASENAME}-1.jpg" "$PROCESSED_DIR/${BASENAME}.thumb.jpg"
                log "Created thumbnail: ${BASENAME}.thumb.jpg"
            fi
        fi

        log "Completed: $FILENAME"
        ;;

    *)
        log "Unknown document format: $EXTENSION_LOWER"
        cp "$INPUT" "$PROCESSED_DIR/$FILENAME"
        ;;
esac

exit 0
