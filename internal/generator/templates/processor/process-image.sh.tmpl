#!/bin/bash
# Image Processor Script
# Generated by dockstart - https://github.com/jpequegn/dockstart
#
# Processes image files: resize, create thumbnails, optimize

set -eo pipefail

# Configuration
PROCESSED_DIR="${PROCESSED_PATH:-/files/processed}"
THUMBNAIL_SIZE="${THUMBNAIL_SIZE:-200x200}"
MAX_DIMENSION="${MAX_DIMENSION:-1920x1080}"
JPEG_QUALITY="${JPEG_QUALITY:-85}"
PNG_QUALITY="${PNG_QUALITY:-65-80}"

# Input file
INPUT="$1"
FILENAME=$(basename "$INPUT")
BASENAME="${FILENAME%.*}"
EXTENSION="${FILENAME##*.}"
EXTENSION_LOWER=$(echo "$EXTENSION" | tr '[:upper:]' '[:lower:]')

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] [image] $*"
}

log "Processing image: $FILENAME"

# Process based on image type
case "$EXTENSION_LOWER" in
    jpg|jpeg)
        # Resize if larger than max dimension
        convert "$INPUT" \
            -resize "${MAX_DIMENSION}>" \
            -quality "$JPEG_QUALITY" \
            "$PROCESSED_DIR/$FILENAME"

        # Create thumbnail
        convert "$INPUT" \
            -resize "${THUMBNAIL_SIZE}^" \
            -gravity center \
            -extent "$THUMBNAIL_SIZE" \
            -quality "$JPEG_QUALITY" \
            "$PROCESSED_DIR/${BASENAME}.thumb.jpg"

        # Optimize with jpegoptim
        if command -v jpegoptim >/dev/null 2>&1; then
            jpegoptim --max="$JPEG_QUALITY" --strip-all -q "$PROCESSED_DIR/$FILENAME" || true
        fi

        log "Created: $FILENAME, ${BASENAME}.thumb.jpg"
        ;;

    png)
        # Resize if larger than max dimension
        convert "$INPUT" \
            -resize "${MAX_DIMENSION}>" \
            "$PROCESSED_DIR/$FILENAME"

        # Create thumbnail
        convert "$INPUT" \
            -resize "${THUMBNAIL_SIZE}^" \
            -gravity center \
            -extent "$THUMBNAIL_SIZE" \
            "$PROCESSED_DIR/${BASENAME}.thumb.png"

        # Optimize with pngquant
        if command -v pngquant >/dev/null 2>&1; then
            pngquant --quality="$PNG_QUALITY" --force --output "$PROCESSED_DIR/$FILENAME" "$PROCESSED_DIR/$FILENAME" 2>/dev/null || true
            pngquant --quality="$PNG_QUALITY" --force --output "$PROCESSED_DIR/${BASENAME}.thumb.png" "$PROCESSED_DIR/${BASENAME}.thumb.png" 2>/dev/null || true
        fi

        log "Created: $FILENAME, ${BASENAME}.thumb.png"
        ;;

    gif)
        # For GIFs, create a static thumbnail from first frame
        convert "${INPUT}[0]" \
            -resize "${THUMBNAIL_SIZE}^" \
            -gravity center \
            -extent "$THUMBNAIL_SIZE" \
            "$PROCESSED_DIR/${BASENAME}.thumb.jpg"

        # Copy original GIF
        cp "$INPUT" "$PROCESSED_DIR/$FILENAME"

        log "Created: $FILENAME, ${BASENAME}.thumb.jpg (from first frame)"
        ;;

    webp)
        # Resize if larger than max dimension
        convert "$INPUT" \
            -resize "${MAX_DIMENSION}>" \
            -quality "$JPEG_QUALITY" \
            "$PROCESSED_DIR/$FILENAME"

        # Create thumbnail
        convert "$INPUT" \
            -resize "${THUMBNAIL_SIZE}^" \
            -gravity center \
            -extent "$THUMBNAIL_SIZE" \
            "$PROCESSED_DIR/${BASENAME}.thumb.webp"

        log "Created: $FILENAME, ${BASENAME}.thumb.webp"
        ;;

    *)
        log "Unknown image format: $EXTENSION_LOWER"
        cp "$INPUT" "$PROCESSED_DIR/$FILENAME"
        ;;
esac

# Get processed file info
if [ -f "$PROCESSED_DIR/$FILENAME" ]; then
    SIZE=$(stat -f%z "$PROCESSED_DIR/$FILENAME" 2>/dev/null || stat -c%s "$PROCESSED_DIR/$FILENAME" 2>/dev/null || echo "?")
    DIMENSIONS=$(identify -format "%wx%h" "$PROCESSED_DIR/$FILENAME" 2>/dev/null || echo "?")
    log "Output: $FILENAME ($DIMENSIONS, $SIZE bytes)"
fi

exit 0
