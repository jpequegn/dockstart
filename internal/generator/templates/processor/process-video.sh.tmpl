#!/bin/bash
# Video Processor Script
# Generated by dockstart - https://github.com/jpequegn/dockstart
#
# Processes video files: generate thumbnails, extract metadata

set -eo pipefail

# Configuration
PROCESSED_DIR="${PROCESSED_PATH:-/files/processed}"
THUMBNAIL_TIME="${THUMBNAIL_TIME:-00:00:01}"  # Time to capture thumbnail
THUMBNAIL_SIZE="${THUMBNAIL_SIZE:-320x180}"

# Input file
INPUT="$1"
FILENAME=$(basename "$INPUT")
BASENAME="${FILENAME%.*}"
EXTENSION="${FILENAME##*.}"
EXTENSION_LOWER=$(echo "$EXTENSION" | tr '[:upper:]' '[:lower:]')

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] [video] $*"
}

log "Processing video: $FILENAME"

case "$EXTENSION_LOWER" in
    mp4|mov|avi|webm|mkv)
        # Copy original video
        cp "$INPUT" "$PROCESSED_DIR/$FILENAME"

        # Generate thumbnail at specified time
        if command -v ffmpeg >/dev/null 2>&1; then
            ffmpeg -y -i "$INPUT" \
                -ss "$THUMBNAIL_TIME" \
                -vframes 1 \
                -vf "scale=${THUMBNAIL_SIZE}:force_original_aspect_ratio=decrease,pad=${THUMBNAIL_SIZE}:(ow-iw)/2:(oh-ih)/2" \
                "$PROCESSED_DIR/${BASENAME}.thumb.jpg" \
                -loglevel error 2>/dev/null || true

            log "Created thumbnail: ${BASENAME}.thumb.jpg"

            # Extract metadata
            ffprobe -v quiet -print_format json -show_format -show_streams "$INPUT" \
                > "$PROCESSED_DIR/${BASENAME}.info.json" 2>/dev/null || true

            log "Created metadata: ${BASENAME}.info.json"

            # Generate animated GIF preview (first 3 seconds)
            ffmpeg -y -i "$INPUT" \
                -t 3 \
                -vf "fps=10,scale=320:-1:flags=lanczos,split[s0][s1];[s0]palettegen[p];[s1][p]paletteuse" \
                "$PROCESSED_DIR/${BASENAME}.preview.gif" \
                -loglevel error 2>/dev/null || true

            log "Created preview GIF: ${BASENAME}.preview.gif"
        else
            log "WARNING: ffmpeg not available, skipping video processing"
        fi

        log "Completed: $FILENAME"
        ;;

    *)
        log "Unknown video format: $EXTENSION_LOWER"
        cp "$INPUT" "$PROCESSED_DIR/$FILENAME"
        ;;
esac

exit 0
